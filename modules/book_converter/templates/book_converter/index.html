{% extends "base.html" %}

{% block title %}The Arcanum â€” Book Converter{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('book_converter.static', filename='style.css') }}">
{% endblock %}

{% block content %}
<!-- Ambient light follower -->
<div class="ambient-light" id="ambientLight"></div>

<div class="converter-wrap">
    
    <div class="converter-header">
        <h1 class="converter-title" data-text="THE ARCANUM">THE ARCANUM</h1>
        <div class="converter-subtitle">Book Converter</div>
    </div>

    <form id="convertForm" enctype="multipart/form-data">
        <div class="grimoire-container">
            <div class="grimoire">
                <div class="grimoire-pages">
                    <div class="grimoire-spine-stitching"></div>
                    
                    <!-- LEFT PAGE: OFFERING (INPUT) -->
                    <div class="page-left">
                        <div class="page-corner-decoration corner-tl"></div>
                        <div class="page-corner-decoration corner-bl"></div>
                        
                        <div class="page-header">
                            Source File
                        </div>
                        
                        <div class="upload-zone" id="dropZone">
                            <div class="upload-icon">ðŸ“œ</div>
                            <div class="upload-text">Upload File</div>
                            <div class="upload-hint">EPUB or PDF</div>
                            <input type="file" id="fileInput" name="file" accept=".epub,.pdf">
                        </div>

                        <div class="file-card" id="fileInfo">
                            <div class="file-icon-box" id="fileIcon">?</div>
                            <div class="file-details">
                                <div class="file-name" id="fileName"></div>
                                <div class="file-size" id="fileSize"></div>
                            </div>
                            <button type="button" class="btn-remove" id="fileRemove" title="Remove File">Ã—</button>
                        </div>

                        <!-- Feedback Area -->
                        <div class="feedback-box box-error" id="errorBox"></div>
                        <div class="feedback-box box-success" id="successBox">
                            <strong>Success</strong><br>
                            <span>The document has been converted.</span>
                        </div>
                    </div>

                    <!-- RIGHT PAGE: RITUAL (CONTROLS) -->
                    <div class="page-right">
                        <div class="page-corner-decoration corner-tr"></div>
                        <div class="page-corner-decoration corner-br"></div>

                        <div class="page-header">
                            Settings
                        </div>

                        <div class="form-group">
                            <span class="label-fancy">Final Format</span>
                            <div class="format-toggle">
                                <button type="button" class="toggle-btn active" data-format="xtc">XTC (E-Ink)</button>
                                <button type="button" class="toggle-btn" data-format="epub" id="epubFormatBtn" disabled>EPUB (Reflow)</button>
                            </div>
                            <input type="hidden" id="outputFormat" name="output_format" value="xtc">
                        </div>

                        <div id="settingsPanel">
                            <div class="form-group">
                                <label class="label-fancy" for="target_width">Target Width (px)</label>
                                <input type="number" id="target_width" name="target_width" value="480" min="100" max="2000">
                            </div>
                            <div class="form-group">
                                <label class="label-fancy" for="font_size">Font Size (pt)</label>
                                <input type="number" id="font_size" name="font_size" value="28" min="8" max="72">
                            </div>
                            <div class="form-group">
                                <label class="label-fancy" for="contrast">Contrast: <span id="contrastVal">1.2</span></label>
                                <input type="range" id="contrast" name="contrast" min="0.5" max="3.0" step="0.1" value="1.2">
                            </div>
                        </div>

                        <!-- Hidden inputs for legacy/defaults -->
                        <input type="hidden" name="dithering" value="true">
                        <input type="hidden" name="margin" value="20">
                        <input type="hidden" name="line_height" value="1.4">

                        <button type="submit" class="btn-transmute" id="submitBtn" disabled>
                            Convert
                        </button>

                        <!-- Progress / Mana Bar -->
                        <div class="ink-progress" id="progressSection">
                            <div class="ink-track">
                                <div class="ink-bar" id="progressFill"></div>
                            </div>
                            <div class="status-text" id="statusText">Converting...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
(function () {
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const fileInfo = document.getElementById('fileInfo');
    const fileIcon = document.getElementById('fileIcon');
    const fileName = document.getElementById('fileName');
    const fileSize = document.getElementById('fileSize');
    const fileRemove = document.getElementById('fileRemove');
    const submitBtn = document.getElementById('submitBtn');
    const form = document.getElementById('convertForm');
    const progressSection = document.getElementById('progressSection');
    const progressFill = document.getElementById('progressFill');
    const statusText = document.getElementById('statusText');
    const errorBox = document.getElementById('errorBox');
    const successBox = document.getElementById('successBox');
    const contrastSlider = document.getElementById('contrast');
    const contrastVal = document.getElementById('contrastVal');
    const ambientLight = document.getElementById('ambientLight');
    
    // Format Toggles
    const outputFormat = document.getElementById('outputFormat');
    const epubFormatBtn = document.getElementById('epubFormatBtn');
    const formatBtns = document.querySelectorAll('.toggle-btn');
    const settingsPanel = document.getElementById('settingsPanel');

    let selectedFile = null;

    // -- Interactive Ambient Light
    document.addEventListener('mousemove', (e) => {
        const x = (e.clientX / window.innerWidth) * 100;
        const y = (e.clientY / window.innerHeight) * 100;
        ambientLight.style.setProperty('--mouse-x', x + '%');
        ambientLight.style.setProperty('--mouse-y', y + '%');
    });

    // -- Contrast slider
    contrastSlider.addEventListener('input', () => {
        contrastVal.textContent = contrastSlider.value;
    });

    // -- Format Selection
    formatBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            if (btn.disabled) return;
            formatBtns.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            const fmt = btn.dataset.format;
            outputFormat.value = fmt;
            
            // Toggle visibility of XTC-only settings
            if (fmt === 'epub') {
                settingsPanel.style.opacity = '0.5';
                settingsPanel.style.pointerEvents = 'none'; // Disable inputs visually
            } else {
                settingsPanel.style.opacity = '1';
                settingsPanel.style.pointerEvents = 'auto';
            }
        });
    });

    // -- Drag & Drop
    ['dragenter', 'dragover'].forEach(evt => {
        dropZone.addEventListener(evt, e => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });
    });

    ['dragleave', 'drop'].forEach(evt => {
        dropZone.addEventListener(evt, e => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
        });
    });

    dropZone.addEventListener('drop', e => {
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            handleFile(files[0]);
        }
    });

    fileInput.addEventListener('change', () => {
        if (fileInput.files.length > 0) {
            handleFile(fileInput.files[0]);
        }
    });

    fileRemove.addEventListener('click', (e) => {
        e.stopPropagation();
        clearFile();
    });
    
    dropZone.addEventListener('click', (e) => {
        if (e.target !== fileInput && e.target !== fileRemove) {
            fileInput.click();
        }
    });

    function handleFile(file) {
        const ext = file.name.split('.').pop().toLowerCase();
        if (ext !== 'epub' && ext !== 'pdf') {
            showError('The spirits reject this form. Only EPUB or PDF are accepted.');
            return;
        }

        selectedFile = file;

        // Update UI
        fileName.textContent = file.name;
        fileSize.textContent = formatSize(file.size);
        fileIcon.textContent = ext.toUpperCase();
        fileInfo.classList.add('visible');
        
        if (ext === 'pdf') {
            epubFormatBtn.disabled = false;
        } else {
            epubFormatBtn.disabled = true;
            if (outputFormat.value === 'epub') {
                 document.querySelector('[data-format="xtc"]').click();
            }
        }

        submitBtn.disabled = false;
        hideError();
        successBox.classList.remove('visible');
    }

    function clearFile() {
        selectedFile = null;
        fileInput.value = '';
        fileInfo.classList.remove('visible');
        submitBtn.disabled = true;
        epubFormatBtn.disabled = true;
        if (outputFormat.value === 'epub') {
             document.querySelector('[data-format="xtc"]').click();
        }
    }

    function formatSize(bytes) {
        const units = ['B', 'KB', 'MB', 'GB'];
        let i = 0;
        while (bytes >= 1024 && i < units.length - 1) {
            bytes /= 1024;
            i++;
        }
        return bytes.toFixed(1) + ' ' + units[i];
    }

    // -- Form Submit
    form.addEventListener('submit', async e => {
        e.preventDefault();
        if (!selectedFile) return;

        hideError();
        successBox.classList.remove('visible');
        submitBtn.disabled = true;
        progressSection.classList.add('visible');
        progressFill.style.width = '0%';
        statusText.textContent = 'Summoning the energies...';

        const formData = new FormData(form);

        try {
            const resp = await fetch('/book-converter/convert', {
                method: 'POST',
                body: formData,
            });

            if (!resp.ok) {
                const err = await resp.json();
                throw new Error(err.error || 'The spell misfired.');
            }

            const contentType = resp.headers.get('content-type') || '';

            if (contentType.includes('application/x-ndjson')) {
                const reader = resp.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop();

                    for (const line of lines) {
                        if (!line.trim()) continue;
                        const event = JSON.parse(line);
                        handleEvent(event);
                    }
                }
                if (buffer.trim()) handleEvent(JSON.parse(buffer));
            } else {
                const data = await resp.json();
                handleEvent(data);
            }
        } catch (err) {
            showError(err.message);
            progressSection.classList.remove('visible');
        }

        submitBtn.disabled = false;
    });

    function handleEvent(event) {
        if (event.type === 'progress') {
            const pct = event.total > 0 ? Math.round((event.current / event.total) * 100) : 0;
            progressFill.style.width = pct + '%';
            if (event.message) statusText.textContent = event.message;
        } else if (event.type === 'done') {
            progressFill.style.width = '100%';
            statusText.textContent = 'Transmutation Complete!';
            successBox.classList.add('visible');

            if (event.download_url) {
                const a = document.createElement('a');
                a.href = event.download_url;
                a.download = event.filename || 'transmuted_tome';
                document.body.appendChild(a);
                a.click();
                a.remove();
            }

            setTimeout(() => {
                progressSection.classList.remove('visible');
            }, 4000);
        } else if (event.type === 'error') {
            showError(event.message);
            progressSection.classList.remove('visible');
        }
    }

    function showError(msg) {
        errorBox.textContent = msg;
        errorBox.classList.add('visible');
    }

    function hideError() {
        errorBox.classList.remove('visible');
        errorBox.textContent = '';
    }
})();
</script>
{% endblock %}
